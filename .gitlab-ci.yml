include:
  - project: 'common/gitlab-ci'
    ref: v0.4.19
    file: '/templates/npm-package-with-container.yml'

stages:
  - test
  - npm_package_build
  - npm_package_publish
  - docker_build
  - build_binaries
  - release_tag
  - push_to_npm

npm-package-build:
  image: registry.kyso.io/kyso-io/kyso-cli:builder-v1.0.5
  before_script:
    - mv /root/node_modules .

npm-package-publish:
  image: registry.kyso.io/kyso-io/kyso-cli:builder-v1.0.5
  before_script:
    - mv /root/node_modules .
    - !reference [.git-config, before_script]
    - !reference [.npm-config, before_script]
  script:
    - !reference [.npm-package-publish, script]
    # Create and push installer tgz package
    - |
      PKG_NAME="kyso-cli-installer"
      PKG_VERS="$CI_COMMIT_TAG"
      PKGS_DIR="$PKG_NAME-$PKG_VERS"
      PKGS_TGZ="$PKG_NAME-$PKG_VERS.tgz"
      UPL_BASE_URL="${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic"
      TGZ_UPLOAD_URL="$UPL_BASE_URL/$PKG_NAME/$PKG_VERS/$PKGS_TGZ"
    - npm view "@kyso-io/kyso-cli@$CI_COMMIT_TAG" dist.tarball >tgz_urls.txt
    - |
      for pkg_ref in $(
        sed -n -e 's%^.*"\(@kyso-io/.*\)": "^*\(.*\)".*$%\1@\2%p' package.json
      ); do
        npm view "$pkg_ref" dist.tarball
      done >>tgz_urls.txt
      sort -u tgz_urls.txt >urls1.txt
      rm -f tgz_urls.txt
    - mkdir "$PKGS_DIR" && cd "$PKGS_DIR"
    - |
      HEADER="Authorization: Bearer ${CI_JOB_TOKEN}"
      echo "Downloading tar files:"
      for tgz_url in $(cat ../urls1.txt); do
        echo "- $tgz_url";
        curl -s -H "$HEADER" "$tgz_url" -O;
      done
    - |
      for pkg_ref in $(
        for tgz in *tgz; do tar xOaf $tgz package/package.json; done |
          sed -n -e 's%^.*"\(@kyso-io/.*\)": "^*\(.*\)".*$%\1@\2%p' |
          sort -u
      ); do
        npm view "$pkg_ref" dist.tarball
      done | sort -u >../urls2.txt
      HEADER="Authorization: Bearer ${CI_JOB_TOKEN}"
      for tgz_url in $(diff ../urls1.txt ../urls2.txt | sed -ne 's/^> //p'); do
        echo "- $tgz_url";
        curl -s -H "$HEADER" "$tgz_url" -O;
      done
      rm -f ../urls1.txt ../urls2.txt
    - |
      echo "Creating install.sh script"
      echo '#!/bin/sh' > install.sh
      echo 'npm cache add *.tgz' >> install.sh
      echo "npm install -g kyso-cli-$PKG_VERS.tgz" >> install.sh
      chmod +x install.sh
      cd ..
    - tar czvf $PKGS_TGZ $PKGS_DIR
    - |
      curl -s --header "JOB-TOKEN: $CI_JOB_TOKEN" --upload-file "$PKGS_TGZ" \
        "$TGZ_UPLOAD_URL"
    - rm -rf "$PKGS_DIR"
    - mv "$PKGS_TGZ" "kyso-cli-installer.tgz"
  artifacts:
    paths:
      - .build-args
      - kyso-cli-installer.tgz
    expire_in: 1 hour

docker-build:
  dependencies:
    - npm-package-publish
  rules:
    - if: '$CI_COMMIT_TAG'

build-binaries:
  stage: build_binaries
  image: registry.kyso.io/kyso-io/kyso-cli:builder-v1.0.5
  rules:
    - if: '$CI_COMMIT_TAG'
  before_script:
    - mv /root/node_modules .
    - !reference [.git-config, before_script]
    - !reference [.npm-config, before_script]
  script:
    # Install missing modules
    - npm install
    # Build binaries
    - |
      npm run packtgz
      rm -rf tarballs
      mkdir tarballs
      mv dist/*.tar.xz tarballs
      npm run packwin
      rm -rf win32
      mv dist/win32 ./win32
      rm -rf dist
  artifacts:
    paths:
      - tarballs/*.tar.xz
      - win32/*.exe
    expire_in: 2 hours

release_tag:
  rules:
    - if: '$CI_COMMIT_TAG'
  script:
    - echo "running release_tag"
    - |
      PKG_NAME="kyso-cli-installer"
      PKG_VERS="$CI_COMMIT_TAG"
      PKGS_TGZ="$PKG_NAME-$PKG_VERS.tgz"
      UPL_BASE_URL="${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic"
      TGZ_UPLOAD_URL="$UPL_BASE_URL/$PKG_NAME/$PKG_VERS/$PKGS_TGZ"
    - |
      release-cli create --name "Release $CI_COMMIT_TAG" \
        --description "kyso-cli release $CI_COMMIT_TAG" \
        --tag-name "$CI_COMMIT_TAG" \
        --assets-link "{\"name\":\"${PKGS_TGZ}\",\"url\":\"${TGZ_UPLOAD_URL}\"}"
  release:

push-to-npm:
  stage: push_to_npm
  image: registry.kyso.io/kyso-io/kyso-cli:builder-v1.0.5
  rules:
    - if: '$CI_COMMIT_TAG'
  script:
    - |-
      PKG_NAME="kyso-cli-installer"
      PKG_VERS="$CI_COMMIT_TAG"
      PKGS_TGZ="$PKG_NAME-$PKG_VERS.tgz"
      UPL_BASE_URL="${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic"
      TGZ_UPLOAD_URL="$UPL_BASE_URL/$PKG_NAME/$PKG_VERS/$PKGS_TGZ"
      echo "Downloading installer '$PKGS_TGZ'"
      curl -s -O --header "JOB-TOKEN: $CI_JOB_TOKEN" "$TGZ_UPLOAD_URL"
    - |
      # Push package to npm
      if [ "$NPMJS_TOKEN" ]; then
        INSTALLER_DIR="$PKG_NAME-$PKG_VERS"
        tar xvzf "$PKGS_TGZ" "$INSTALLER_DIR"
        cd "$INSTALLER_DIR"
        echo "@kyso-io:registry=https://registry.npmjs.org" >".npmrc"
        echo "//registry.npmjs.org/:_authToken=${NPMJS_TOKEN}" >>".npmrc"
        failed=""
        for tgz in $(ls -tr *.tgz); do
          echo "Publishing file '$tgz'"
          npm publish --userconfig ".npmrc" --access public "$tgz" ||
            failed="$failed $_tgz"
        done
        cd ..
        rm -rf "$PKGS_TGZ" "$INSTALLER_DIR"
        for tgz in $failed; do
          echo "Publication of the '$tgz' package failed!"
          echo "Check if it was already published or something else is wrong"
        done
      fi

variables:
  DOCKER_BUILDKIT: 1
