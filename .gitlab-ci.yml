include:
  - project: 'common/gitlab-ci'
    ref: v0.4.13
    file: '/templates/npm-package-with-container.yml'

npm-package-build:
  image: registry.kyso.io/kyso-io/kyso-cli:builder-v1.0.2
  before_script:
    - mv /root/node_modules .

npm-package-publish:
  image: registry.kyso.io/kyso-io/kyso-cli:builder-v1.0.2
  before_script:
    - mv /root/node_modules .
    - !reference [.git-config, before_script]
    - !reference [.npm-config, before_script]
  after_script:
    - PACKAGES_DIR="kyso-cli-packages-$CI_COMMIT_TAG"
    - PACKAGE_URLS="$PACKAGES_DIR/package-urls.txt"
    - mkdir "$PACKAGES_DIR"
    - npm view "@kyso-io/kyso-cli@$CI_COMMIT_TAG" > "$PACKAGE_URLS"
    - |
      for pkg_ref in $(
        sed -n -e 's%^.*"\(@kyso-io/.*\)": "\(.*\)".*$%"\1@\2"%p' package.json
      ); do
        npm view "$pkg_ref" >> "$PACKAGE_URLS"
      done
docker-build:
  dependencies:
    - npm-package-publish

release_tag:
  dependencies:
    - npm-package-publish
  rules:
    - if: '$CI_COMMIT_TAG'
  script:
    - echo "running release_tag"
    - PACKAGES_DIR="kyso-cli-packages-$CI_COMMIT_TAG"
    - cd "$PACKAGES_DIR"
    - |
      for pkg_url in $(cat package-urls.txt); do
        curl -s -H "Authorization: Bearer ${CI_JOB_TOKEN}" "$pkg_url" -O
      done
    - rm package-urls.txt
    - echo '#!/bin/sh' > install.sh
    - echo 'npm install -g *.tgz' >> install.sh
    - chmod +x install.sh
    - cd ..
    - tar cf $PACKAGES_TGZ $PACKAGES_DIR
    - |
      curl --header "Authorization: Bearer ${CI_JOB_TOKEN}" \
           --upload-file "${PACKAGES_TGZ}" \
           "${PACKAGE_REGISTRY_URL}"
    - rm -rf "$PACKAGES_TGZ" "$PACKAGES_DIR"
    - release-cli create --name "Release $CI_COMMIT_TAG" \
        --description "Created using the release-cli"
        --tag-name "$CI_COMMIT_TAG" \
        --ref "$CI_COMMIT_TAG" \
        --assets-link "{\"name\":\"${PACKAGES_TGZ}\",\"url\":\"${PACKAGE_REGISTRY_URL}/${PACKAGES_TGZ}\"}"
  release:

variables:
  DOCKER_BUILDKIT: 1
